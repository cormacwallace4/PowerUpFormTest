<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Initial Consultation Questionnaire</title>
  <meta name="description" content="Initial Consultation Questionnaire" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background-color: #709874; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .page { padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .title { margin: 6px 0 16px 0; font-size: 26px; text-align: center; }
    .intro { margin-bottom: 24px; }
    .section { margin: 28px 0 10px 0; font-size: 20px; color: #333; }
    .field { margin-bottom: 14px; }
    .field.inline { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    .label-inline { font-weight: 600; margin-right: 8px; }
    .choice { display: inline-flex; gap: 6px; align-items: center; margin-right: 12px; }
    .field input[type="text"],
    .field input[type="email"],
    .field input[type="tel"],
    .field input[type="number"],
    .field input[type="date"],
    .field textarea {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      background: #fafafa;
      border-radius: 8px;
      overflow: hidden;
    }
    .table th, .table td {
      border: 1px solid #eee;
      padding: 10px;
      font-size: 14px;
    }
    .actions { display: flex; justify-content: center; margin-top: 16px; }
    .actions.left { justify-content: flex-start; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 8px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      background: #709874;
      color: #fff;
    }
    .btn.small { padding: 6px 10px; font-size: 13px; }
    .btn.danger { background: #b00020; }

    /* Styles for PDF clone so values look like filled fields */
    .readonly-field {
      display: block;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 12px;
      background: #fff;
      white-space: pre-wrap;
      min-height: 20px;
      font-size: 14px;
    }
    .readonly-inline { display: inline-block; padding: 0 6px; border-radius: 4px; border: 1px solid #ddd; }
    .pdf-frame {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: none;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      font-size: 13px;
      margin-right: 8px;
    }
    .tick { font-weight: 700; }
    .pdf-hidden { position: fixed; left: -99999px; top: 0; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <main class="page">
    <div class="container">
      <form class="card" id="intakeForm" action="" data-gas-url="https://script.google.com/macros/s/...MQ/exec" method="POST" enctype="multipart/form-data" novalidate>
        <input type="hidden" name="_subject" value="New Intake Form Submission" />
        <div id="formStatus" aria-live="polite" style="margin:8px 0 0 0;"></div>

        <h2 style="text-align:center; font-size:34px; color:#709874; font-weight:700; letter-spacing:1px; margin:0 0 12px 0;">
          POWER UP NUTRITION
        </h2>
        <h1 class="title">Initial Consultation Questionnaire</h1>

        <p class="intro">
          This questionnaire will be combined with information gathered during the consultation and used to build an
          individual nutritional program specifically tailored to your needs and lifestyle. Please answer as accurately
          as you can. All personal information provided is strictly confidential.
        </p>

        <!-- Client details -->
        <div class="field">
          <label for="clientRegistration" style="font-weight:600;">Client registration number</label>
          <input type="text" id="clientRegistration" name="clientRegistration" placeholder="Click or tap here to enter text." />
        </div>

        <div class="field">
          <div class="field">
            <label for="name" style="font-weight:600;">Client name</label>
            <input type="text" id="name" name="name" placeholder="Click or tap here to enter text." />
          </div>
          <div class="field">
            <label for="dob" style="font-weight:600;">Date of Birth</label>
            <input type="date" id="dob" name="dob" />
          </div>
        </div>

        <div class="field inline">
          <span class="label-inline">Sex</span>
          <label class="choice"><input type="radio" name="sex" value="M" /> M</label>
          <label class="choice"><input type="radio" name="sex" value="F" /> F</label>
        </div>

        <div class="field">
          <label for="occupation" style="font-weight:600;">Occupation (active/sedentary)</label>
          <input type="text" id="occupation" name="occupation" placeholder="Click or tap here to enter text." />
        </div>

        <!-- If known -->
        <div class="field">
          <span style="font-weight:600;">If known</span>
          <div class="field">
            <label for="height" style="font-weight:600;">Height (cm)</label>
            <input type="number" id="height" name="height" placeholder="Click or tap here to enter number." step="1" min="0" />
          </div>
          <div class="field">
            <label for="weight" style="font-weight:600;">Weight (kg)</label>
            <input type="number" id="weight" name="weight" placeholder="Click or tap here to enter number." step="0.1" min="0" />
          </div>
        </div>

        <!-- Address and contact -->
        <div class="field">
          <label for="address" style="font-weight:600;">Address</label>
          <textarea id="address" name="address" rows="2" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <div class="field">
          <label for="phone" style="font-weight:600;">Phone</label>
          <input type="tel" id="phone" name="phone" placeholder="Click or tap here to enter text." />
        </div>

        <div class="field">
          <label for="email" style="font-weight:600;">Email</label>
          <input type="email" id="email" name="email" placeholder="Click or tap here to enter text." />
        </div>

        <!-- GP details -->
        <div class="field">
          <label for="gpName" style="font-weight:600;">GP Name</label>
          <input type="text" id="gpName" name="gpName" placeholder="Click or tap here to enter text." />
        </div>
        <div class="field">
          <label for="gpAddress" style="font-weight:600;">GP Address</label>
          <textarea id="gpAddress" name="gpAddress" rows="2" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Emergency contact -->
        <div class="field">
          <label for="emergencyContact" style="font-weight:600;">Emergency contact (name and number)</label>
          <input type="text" id="emergencyContact" name="emergencyContact" placeholder="Click or tap here to enter text." />
        </div>

        <!-- Presenting symptoms -->
        <h2 class="section">Section 1: Presenting Symptoms</h2>
        <div class="field">
          <label for="presentingSymptoms" style="font-weight:600;">Please provide details of your main health concerns</label>
          <textarea id="presentingSymptoms" name="presentingSymptoms" rows="4" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Medical history -->
        <h2 class="section">Section 2: Medical History</h2>
        <div class="field">
          <label for="pastMedicalHistory" style="font-weight:600;">Please provide details of any past medical conditions or operations</label>
          <textarea id="pastMedicalHistory" name="pastMedicalHistory" rows="4" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <div class="field">
          <label for="familyHistory" style="font-weight:600;">Family medical history</label>
          <textarea id="familyHistory" name="familyHistory" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Medications -->
        <h2 class="section">Section 3: Medications</h2>
        <p>Please list all current medications, including dosage and frequency. Use the “Add” button to include more rows.</p>

        <table class="table">
          <thead>
            <tr>
              <th>Medication</th>
              <th>Dosage</th>
              <th>Frequency</th>
              <th>Reason</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="medicationsBody">
            <tr class="medRow">
              <td><input type="text" name="medication_0_name" placeholder="Name" /></td>
              <td><input type="text" name="medication_0_dosage" placeholder="Dosage" /></td>
              <td><input type="text" name="medication_0_frequency" placeholder="Frequency" /></td>
              <td><input type="text" name="medication_0_reason" placeholder="Reason" /></td>
              <td><button type="button" class="btn small danger removeRowBtn">Remove</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions left">
          <button type="button" id="addMedicationBtn" class="btn">Add Medication</button>
        </div>

        <!-- Supplements -->
        <h2 class="section">Section 4: Supplements</h2>
        <p>List any vitamins, minerals, herbs, or other supplements you are currently taking.</p>

        <table class="table">
          <thead>
            <tr>
              <th>Supplement</th>
              <th>Dosage</th>
              <th>Frequency</th>
              <th>Reason</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="supplementsBody">
            <tr class="suppRow">
              <td><input type="text" name="supplement_0_name" placeholder="Name" /></td>
              <td><input type="text" name="supplement_0_dosage" placeholder="Dosage" /></td>
              <td><input type="text" name="supplement_0_frequency" placeholder="Frequency" /></td>
              <td><input type="text" name="supplement_0_reason" placeholder="Reason" /></td>
              <td><button type="button" class="btn small danger removeRowBtn">Remove</button></td>
            </tr>
          </tbody>
        </table>
        <div class="actions left">
          <button type="button" id="addSupplementBtn" class="btn">Add Supplement</button>
        </div>

        <!-- Allergies -->
        <h2 class="section">Section 5: Allergies and Intolerances</h2>
        <div class="field">
          <label for="allergies" style="font-weight:600;">Please list any known allergies and intolerances</label>
          <textarea id="allergies" name="allergies" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Diet -->
        <h2 class="section">Section 6: Diet</h2>
        <div class="field">
          <label for="typicalDiet" style="font-weight:600;">Describe your typical daily diet</label>
          <textarea id="typicalDiet" name="typicalDiet" rows="4" placeholder="Breakfast, lunch, dinner, snacks, drinks"></textarea>
        </div>

        <div class="field">
          <label for="foodCravings" style="font-weight:600;">Food cravings</label>
          <input type="text" id="foodCravings" name="foodCravings" placeholder="Click or tap here to enter text." />
        </div>

        <div class="field">
          <label for="foodDislikes" style="font-weight:600;">Foods you dislike or avoid</label>
          <input type="text" id="foodDislikes" name="foodDislikes" placeholder="Click or tap here to enter text." />
        </div>

        <!-- Lifestyle -->
        <h2 class="section">Section 7: Lifestyle</h2>
        <div class="field">
          <label for="exercise" style="font-weight:600;">Exercise and activity level</label>
          <textarea id="exercise" name="exercise" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <div class="field">
          <label for="sleep" style="font-weight:600;">Sleep quality and duration</label>
          <textarea id="sleep" name="sleep" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <div class="field">
          <label for="stress" style="font-weight:600;">Stress levels and sources</label>
          <textarea id="stress" name="stress" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Digestion -->
        <h2 class="section">Section 8: Digestion</h2>
        <div class="field">
          <label for="digestion" style="font-weight:600;">Digestive health notes</label>
          <textarea id="digestion" name="digestion" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Female health -->
        <h2 class="section">Section 9: Female Health (if applicable)</h2>
        <div class="field">
          <label for="femaleHealth" style="font-weight:600;">Cycle, symptoms, contraception, menopause</label>
          <textarea id="femaleHealth" name="femaleHealth" rows="3" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Goals -->
        <h2 class="section">Section 10: Goals</h2>
        <div class="field">
          <label for="goals" style="font-weight:600;">Your primary goals and expectations</label>
          <textarea id="goals" name="goals" rows="4" placeholder="Click or tap here to enter text."></textarea>
        </div>

        <!-- Consent -->
        <h2 class="section">Section 11: Consent</h2>
        <div class="field inline">
          <label class="choice">
            <input type="checkbox" name="consent_data" value="yes" />
            I consent to my data being used for the purpose of nutritional consultation and stored securely.
          </label>
        </div>

        <!-- Submit -->
        <div class="actions">
          <button type="submit" class="btn">Submit</button>
        </div>

      </form>
    </div>
  </main>

  <!-- Row add/remove scripts -->
  <script>
  (function () {
    var body = document.getElementById('medicationsBody');
    var addBtn = document.getElementById('addMedicationBtn');
    var idx = body ? body.querySelectorAll('tr.medRow').length : 0;

    function addRow() {
      idx += 1;
      var tr = document.createElement('tr');
      tr.className = 'medRow';
      tr.innerHTML = [
        '<td><input type="text" name="medication_' + idx + '_name" placeholder="Name" /></td>',
        '<td><input type="text" name="medication_' + idx + '_dosage" placeholder="Dosage" /></td>',
        '<td><input type="text" name="medication_' + idx + '_frequency" placeholder="Frequency" /></td>',
        '<td><input type="text" name="medication_' + idx + '_reason" placeholder="Reason" /></td>',
        '<td><button type="button" class="btn small danger removeRowBtn">Remove</button></td>'
      ].join('');
      body.appendChild(tr);
    }

    function removeRow(btn) {
      var tr = btn.closest('tr');
      if (tr && tr.parentNode) tr.parentNode.removeChild(tr);
    }

    if (addBtn && body) {
      addBtn.addEventListener('click', addRow);
      body.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('removeRowBtn')) {
          removeRow(e.target);
        }
      });
    }
  })();
  </script>

  <script>
  (function () {
    var body = document.getElementById('supplementsBody');
    var addBtn = document.getElementById('addSupplementBtn');
    var idx = body ? body.querySelectorAll('tr.suppRow').length : 0;

    function addRow() {
      idx += 1;
      var tr = document.createElement('tr');
      tr.className = 'suppRow';
      tr.innerHTML = [
        '<td><input type="text" name="supplement_' + idx + '_name" placeholder="Name" /></td>',
        '<td><input type="text" name="supplement_' + idx + '_dosage" placeholder="Dosage" /></td>',
        '<td><input type="text" name="supplement_' + idx + '_frequency" placeholder="Frequency" /></td>',
        '<td><input type="text" name="supplement_' + idx + '_reason" placeholder="Reason" /></td>',
        '<td><button type="button" class="btn small danger removeRowBtn">Remove</button></td>'
      ].join('');
      body.appendChild(tr);
    }

    function removeRow(btn) {
      var tr = btn.closest('tr');
      if (tr && tr.parentNode) tr.parentNode.removeChild(tr);
    }

    if (addBtn && body) {
      addBtn.addEventListener('click', addRow);
      body.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('removeRowBtn')) {
          removeRow(e.target);
        }
      });
    }
  })();
  </script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIP3M3kGm3HQovb0m9ycUu8JQkq7zX1bH5gFQn4oIhIE4m0wR5S0kWJvKp9nci0fO2v2m0iUQq1Y4ZkG4QJQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Helper to clone the form into a printable, filled layout -->
  <script>
    function buildPrintableClone(sourceForm) {
      // Deep clone
      var clone = sourceForm.cloneNode(true);

      // Remove the submit row in the clone
      var actions = clone.querySelectorAll('.actions');
      actions.forEach(function(a){ a.parentNode.removeChild(a); });

      // Convert inputs, textareas, selects into readonly blocks that show values
      var inputs = clone.querySelectorAll('input, textarea, select');
      inputs.forEach(function(el){
        var type = (el.getAttribute('type') || '').toLowerCase();
        var tag = el.tagName.toLowerCase();
        var parent = el.parentNode;

        function replaceWithSpan(text, block){
          var span = document.createElement(block ? 'div' : 'span');
          span.className = block ? 'readonly-field' : 'readonly-inline';
          span.textContent = text && text.trim() ? text : '';
          parent.replaceChild(span, el);
        }

        if (tag === 'textarea') {
          replaceWithSpan(el.value, true);
          return;
        }

        if (tag === 'select') {
          var chosen = el.options && el.selectedIndex >= 0 ? el.options[el.selectedIndex].text : '';
          replaceWithSpan(chosen, false);
          return;
        }

        // Inputs by type
        if (type === 'radio' || type === 'checkbox') {
          // For radios/checkboxes inside labels like: <label class="choice"><input ...> Label</label>
          // Replace the input with a tick/empty box marker
          var marker = document.createElement('span');
          marker.className = 'pill tick';
          var checked = el.checked;
          marker.textContent = checked ? '☑' : '☐';
          parent.replaceChild(marker, el);
          return;
        }

        // Text-ish inputs
        if (['text','email','tel','number','date','url','search','password'].indexOf(type) >= 0 || type === '') {
          // Format date inputs to a readable string if present
          var v = el.value;
          replaceWithSpan(v, true);
          return;
        }

        // Fallback: remove unknown inputs in clone
        replaceWithSpan('', true);
      });

      // Return a framed container that mimics the card
      var wrapper = document.createElement('div');
      wrapper.className = 'pdf-frame';
      // Duplicate the title/branding above the clone for nicer top spacing
      var brand = document.createElement('div');
      brand.innerHTML = '<h2 style="text-align:center; font-size:34px; color:#709874; font-weight:700; letter-spacing:1px; margin:0 0 12px 0;">POWER UP NUTRITION</h2>' +
                        '<h1 class="title">Initial Consultation Questionnaire</h1>';
      wrapper.appendChild(brand);
      wrapper.appendChild(clone);
      return wrapper;
    }
  </script>

  <!-- NEW: Submit to Google Apps Script with a real visual PDF attached -->
  <script>
  (function () {
    var form = document.getElementById('intakeForm');
    if (!form) return;

    function setStatus(msg, ok) {
      var box = document.getElementById('formStatus');
      if (!box) return;
      box.textContent = msg;
      box.style.color = ok ? '#2e7d32' : '#b00020';
      box.style.fontWeight = '600';
    }

    function buildFilename() {
      var dateStr = new Date().toISOString().slice(0, 10);
      var base = 'Initial-Consultation-Questionnaire-' + dateStr + '.pdf';
      return base.replace(/\\s+/g, '_');
    }

    async function generateVisualPdfBlobFromClone(sourceForm) {
      // Build off-DOM printable clone so the user-visible form remains untouched
      var cloneFrame = buildPrintableClone(sourceForm);
      var host = document.createElement('div');
      host.className = 'pdf-hidden';
      host.appendChild(cloneFrame);
      document.body.appendChild(host);

      var opt = {
        margin: [10,10,10,10],
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0, logging: false, allowTaint: false },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css','legacy'] }
      };

      try {
        var blob = await html2pdf().set(opt).from(cloneFrame).toPdf().get('pdf').then(function(pdf){
          return pdf.output('blob');
        });
        return blob;
      } finally {
        // Clean up
        document.body.removeChild(host);
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();

      var submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
      if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Generating PDF…'; }
      setStatus('Generating a PDF that looks exactly like your filled form…', true);

      var pdfBlob = null;
      try {
        pdfBlob = await generateVisualPdfBlobFromClone(form);
      } catch (err) {
        console.error('PDF generation failed:', err);
        setStatus('Could not generate the visual PDF. Please try again.', false);
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }
        return;
      }

      var gasUrl = form.getAttribute('data-gas-url');
      if (!gasUrl || !/^https?:\\/\\//i.test(gasUrl)) {
        setStatus('Missing Apps Script URL. Edit data-gas-url on the form.', false);
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }
        return;
      }

      setStatus('Uploading…', true);

      // Build multipart form data with all the answers
      var fd = new FormData(form);
      // Attach the visual PDF blob
      fd.append('pdf', pdfBlob, buildFilename());

      try {
        if (submitBtn) submitBtn.textContent = 'Submitting…';
        var resp = await fetch(gasUrl, { method: 'POST', body: fd });

        if (resp.ok) {
          setStatus('Thank you! Your form has been submitted with a visual PDF attached.', true);
          try { form.reset(); } catch (e) {}
          window.location.href = 'thanks.html';
        } else {
          var t = await resp.text();
          console.error('GAS error:', t);
          setStatus('Submission failed. Please try again or contact us.', false);
        }
      } catch (err) {
        console.error('Network error:', err);
        setStatus('Network error. Please try again later.', false);
      } finally {
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }
      }
    }

    // Replace any old listeners
    try {
      var newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);
      form = newForm;
    } catch (e) {}

    form.addEventListener('submit', handleSubmit);
  })();
  </script>

</body>
</html>
